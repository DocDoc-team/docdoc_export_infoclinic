Docdoc: Модуль интеграции с МИС Инфоклиника
===========================================

Данное программное обеспечение:

- не требует установки никаких сторонних программ, разработано для любых 
версий ОС Windows, начиная с Windows 2000/XP и до Windows 10, и 
предназначено для обеспечения интеграции на онлайн-расписание Клиники, 
работающей на МИС Инфоклиника, и Docdoc.ru.

- представляет из себя набор скриптов с открытым исходным кодом. 
Это в том числе позволяет убедиться в полной безопасности данного решения 
любому грамотному системному администратору.

- позволяет обеспечить автоматизированную интеграцию на онлайн-расписание
врачей и диагностик.

---


УСТАНОВКА
---------

Установка заключается в распаковке архива с проектом в отдельную
папку. Например C:\docdoc_export, E:\integrations\docdoc\ftpexport
или любую иную.

Вы должны будете увидеть список из следующих файлов и подпапок:

      export/                   папка для временного хранения файлов выгрузки
      sql/                      SQL скрипты для чтения данных из БД Инфоклиники
      tmp/                      временные файлы
      docdoc_do_export.bat      основной скрипт
      docdoc_export.bat         скрипт генерации файлов выгрузки
      docdoc_export_config.bat  конфигурационный файл
      docdoc_upload.bat         скрипт загрузки подготовленных файлов на FTP
      readme.md                 этот файл

---


СИСТЕМНЫЕ ТРЕБОВАНИЯ
--------------------

###Операционная система:

Клиентские системы Windows 2000, Windows XP SP2 и SP3 и выше

Серверные системы Windows Server 2003, 2008 и выше


###Требования к железу:

Минимальны, решение работоспособно на уровне компьютерной
техники 2000-х годов и выше.

Для примера, будет работать вполне неплохо на конфигурации с
Intel Pentium IV @2.6 ГГц (одноядерный, с HT)
и 16 Мб свободной оперативной памяти.

Естественно, желательна более современная конфигурация.


###Доступ в сеть интернет:

Скорость от 1 Мбит/с входящая, от 1 Мбит/с исходящая

---

На технике и связи с сетью уровня 2015-го года работа скриптов практически моментальна.

---

КРАТКОЕ РУКОВОДСТВО
-------------------

Прежде всего предлагаем ознакомиться со скриптами .bat в корне папки.
Далее осмотреть sql скрипты в папке sql, все они достаточно просты.


###Первый шаг - настройка конфигурационного файла docdoc_export_config.bat

Файл достаточно неплохо самодокументирован, см. комметрарии в файле.

Юзера БД для выгрузки можно использовать любого, у которого есть права 
на чтение соответствующих таблиц БД Инфоклиники.
Самое простое - использовать встроенного в Interbase/Firebird суперюзера SYSDBA.

Как вариант, можно воспользоваться стандартным юзером БД Инфоклиники CHEA,
или же создать отдельного юзера специально для выгрузки. На наш взгляд эти
варианты лишены практического смысла и достаточно использовать суперюзера SYSDBA,
но полезно о них упомянуть для полноты представления.

Путь к базе можно посмотреть или в aliases.conf в корне установки Firebird,
или отыскать вручную, ища файлы с расширением .FDB .

Кроме того, необходимо прописать в fbpath полный путь до bin папки
Firebird (включая саму bin), в которой находится штатная утилита isql.exe
("Interactive SQL"). Эта утилита умеет работать не только в интерактивном режиме,
но и позволяет себя использовать в режиме одной команды, что используется
в скрипте экспорта.

Также, необходимо отредактировать настройки, касающиеся FTP сервера, 
на который будет происходить выгрузка.

Данные для этого (сервер, логин, пароль) необходимо получить от Docdoc.ru.

Стартовая директория FTP как правило не требуется, в таком случае её надо
оставить пустой:

    set ftpstartdir=


###Второй шаг - проверка работы скрипта экспорта docdoc_export.bat

Запускаем docdoc_export.bat . Этот скрипт отвечает за выгрузку данных для
онлайн-расписания из таблиц БД Инфоклиника в формат CSV в подпапку /export.

Подпапка /export должна быть доступна для записи юзеру, 
от имени которого запускается скрипт.

CSV формат файлов выбран стандартный для русскоязычной версии MS Excel :

- разделителем столбцов является точка-с-запятой ";",
- значения данных обрамлены в двойные кавычки
- в случае встречи символа <"> он экранируется как <"">
- конец строки в windows стиле (символы CR+LF)

Это позволяет, в частности, совершенно просто открывать эти файлы в 
MS Excel для просмотра.

Пример вывода в консоль при корректной отработке скрипта:

    Loading...
    Cleaning from old export files
    Generate new fresh export files
    - clinics
    - doctors
    - depts
    - doctschedule
    - schedule
    Prepare export files for uploading
    - clinics
    - doctors
    - depts
    - doctschedule
    - schedule
    Export files generated.

В результате успешной отработки скрипта, в папке /export должны будут
создаться (или перезаписаться) соответственно файлы

    - clinics.csv
    - doctors.csv
    - depts.csv
    - doctschedule.csv
    - schedule.csv

которые можно просмотреть на корректность отдаваемых данных как в любом
текстовом редакторе, так и в табличном виде, открыв через Excel.


###Третий шаг - проверка работы скрипта выгрузки на FTP docdoc_upload.bat

Запускаем docdoc_upload.bat . Этот скрипт отвечает за отправку подготовленных
предыдущим (docdoc_export.bat) скриптом файлов данных для онлайн-расписания
из папки /export в сеть на FTP сервер Docdoc.

Подпапка /tmp должна быть доступна для записи юзеру, 
от имени которого запускается скрипт.

Это требуется ввиду того, что в начале работы скрипта в /tmp генерируется
временный файл, в который записывается последовательность FTP команд. 
Этот файл с командами далее передаётся как параметр для вызова штатной
утилиты Windows ftp.exe, служащей для взаимодействия с FTP серверами.

Пример вывода в консоль при корректной отработке скрипта:

    Uploading...
    Связь с ftp.selcdn.ru.
    220 Selectel Cloud Storage FTP
    ftp> USER 29291_stolica
    331 Password required for 29291_stolica.
    
    230 User logged in, proceed
    ftp> CD stolica
    250 Requested File Action Completed OK
    ftp> BINARY
    200 Type set to I.
    ftp> PUT .\export\clinics.csv
    200 PORT OK
    125 Data connection already open, starting transfer
    226 Transfer Complete.
    ftp: 84 байт отправлено за 0,00 (сек) со скоростью 84000,00 (КБ/сек).
    ftp> PUT .\export\doctors.csv
    200 PORT OK
    125 Data connection already open, starting transfer
    226 Transfer Complete.
    ftp: 48101 байт отправлено за 0,00 (сек) со скоростью 48101000,00 (КБ/сек).
    ftp> PUT .\export\depts.csv
    200 PORT OK
    125 Data connection already open, starting transfer
    226 Transfer Complete.
    ftp: 1700 байт отправлено за 0,00 (сек) со скоростью 1700000,00 (КБ/сек).
    ftp> PUT .\export\doctschedule.csv
    200 PORT OK
    125 Data connection already open, starting transfer
    226 Transfer Complete.
    ftp: 74 байт отправлено за 0,01 (сек) со скоростью 4,93 (КБ/сек).
    ftp> PUT .\export\schedule.csv
    200 PORT OK
    125 Data connection already open, starting transfer
    226 Transfer Complete.
    ftp: 44 байт отправлено за 0,00 (сек) со скоростью 44000,00 (КБ/сек).
    ftp> QUIT
    221 Goodbye.
    Done.


###Четвёртый шаг - запуск автоматической выгрузки

Скрипт docdoc_do_export.bat для обеспечения автоматической выгрузки делает
ничто иное как последовательно запускает

- docdoc_export.bat для генерации свежих файлов для экспорта
- и затем сразу docdoc_upload.bat для закачки этих файлов на FTP

и более ничего.

Убедившись в шагах с первого по третий в содержании и работоспособности
скриптов, остаётся сделать финальный шаг для запуска интеграции.

Прописать docdoc_do_export.bat в планировщике задач на запуск
каждые 15 минут.

При большом общем потоке заявок в клинику и, соответственно, частом
изменении свободного расписания врача, может быть обосновано увеличение
частоты выгрузки до каждых 10 или даже 5 минут.

Делать выгрузку реже раза в 15 минут не рекомендуется, по очевидным 
соображениям заботы об актуальности данных о свободном времени врачей.


###Пятый шаг - рекомендации по безопасности

Для скрипта с конфигурационными настройками docdoc_export_config.bat,
а также до содержимого подпапки /tmp, рекомендуется  ограничить доступ
только для администраторов (и юзера, из под которого запускается скрипт,
в случае запуска скрипта не под администратором). Для всех остальных не
следует предоставлять доступ даже на чтение, ввиду хранения в этих файлах
конфиденциальных данных вроде логинов и паролей.

---


ЧТО ДАЛЬШЕ
-----------

Рассматривается возможность реализации на том же механизме онлайн-записи
из Docdoc.ru в клинику.

По вопросам по модулю и поддержке обращайтесь к нам в Docdoc.ru

Команда разработчиков Докдок
http://docdoc.ru